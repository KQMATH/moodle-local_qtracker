define("local_qtracker/questions_table_page",["exports","jquery","core/templates","core/ajax","core/url","local_qtracker/sidebar"],(function(_exports,_jquery,_templates,_ajax,_url,_sidebar){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_url=_interopRequireDefault(_url),_sidebar=_interopRequireDefault(_sidebar);var _default=class{constructor(courseid){var obj,key,value;value=null,(key="courseid")in(obj=this)?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,this.courseid=courseid,this.sidebar=new _sidebar.default("#questions-table-sidebar",!1,"right",!1,"20%"),this.init()}async init(){await this.sidebar.render(),window.showIssuesInPane=async function(id){let state=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.sidebar.empty(),this.sidebar.setLoading(!0);let questionData=await this.loadQuestionData(id),question=questionData.question,questionEditUrl=this.getQuestionEditUrl(this.courseid,id),link=(0,_jquery.default)("<a></a>").attr("href",questionEditUrl).html(question.name+" #"+question.id);this.sidebar.setTitle(link),this.sidebar.show();let issuesResponse=await this.loadIssues(id,state),issues=issuesResponse.issues,userids=[...new Set(issues.map((issue=>issue.userid)))],usersData=await this.loadUsersData(userids),promises=[];issues.forEach((async issueData=>{let userData=usersData.find((_ref=>{let{id:id}=_ref;return id===issueData.userid}));promises.push(this.addIssueItem(issueData,userData))})),self=this,_jquery.default.when.apply(_jquery.default,promises).done((function(){self.sidebar.setLoading(!1),_jquery.default.each(arguments,((index,argument)=>{self.sidebar.addTemplateItem(argument.html,argument.js)}))})).catch((e=>{console.error(e)}))}.bind(this),window.closeIssuesPane=function(){this.sidebar.hide()}.bind(this),window.toggleIssuesPane=function(){this.sidebar.togglePane()}.bind(this)}async addIssueItem(issueData,userData){let paneContext={issueurl:_url.default.relativeUrl("/local/qtracker/issue.php",{courseid:this.courseid,issueid:issueData.id}),userurl:_url.default.relativeUrl("/user/view.php",{course:this.courseid,id:userData.id}),profileimageurl:userData.profileimageurlsmall,fullname:userData.fullname,timecreated:issueData.timecreated,id:issueData.id,title:issueData.title,description:issueData.description};return paneContext[issueData.state]=!0,_templates.default.render("local_qtracker/sidebar_item_issue",paneContext).then((function(html,js){return{html:html,js:js}}))}async loadIssues(id){let state=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,criteria=[{key:"questionid",value:id}];return state&&criteria.push({key:"state",value:state}),await _ajax.default.call([{methodname:"local_qtracker_get_issues",args:{criteria:criteria}}])[0]}async loadUsersData(ids){return await _ajax.default.call([{methodname:"core_user_get_users_by_field",args:{field:"id",values:ids}}])[0]}getQuestionEditUrl(courseid,questionid){let returnurl=encodeURIComponent(location.pathname+location.search);return _url.default.relativeUrl("/question/bank/editquestion/question.php",{courseid:courseid,id:questionid,returnurl:returnurl})}decodeHTML(html){return(new DOMParser).parseFromString(html,"text/html").documentElement.textContent}async loadQuestionData(id){return await _ajax.default.call([{methodname:"local_qtracker_get_question",args:{id:id}}])[0]}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=questions_table_page.min.js.map