define("local_qtracker/dropdown",["exports","jquery","core/templates","core/str","local_qtracker/dropdown_events","local_qtracker/api_helpers"],(function(_exports,_jquery,_templates,_str,_dropdown_events,_api_helpers){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_dropdown_events=_interopRequireDefault(_dropdown_events);var SELECTORS_DROPDOWN='[data-region="dropdown"]',SELECTORS_SEARCH='input[type="search"]',SELECTORS_ITEM='[data-region="item"]';var _default=class{constructor(root){let search=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];_defineProperty(this,"loading",null),_defineProperty(this,"root",null),_defineProperty(this,"items",new Map),_defineProperty(this,"activeItems",new Map),_defineProperty(this,"isSearching",!1),this.root=(0,_jquery.default)(root),this.dropdown=this.root.find(SELECTORS_DROPDOWN),this.search=search,this.render=this.renderItems.bind(this),this.registerEventListeners=this.registerEventListeners.bind(this),this.search&&this.registerEventListeners()}getDropdown(){return this.dropdown}getRoot(){return this.root}registerEventListeners(){this.getDropdown().on("click",SELECTORS_ITEM,function(e){let element=(0,_jquery.default)(e.currentTarget);if(!element.hasClass("disabled")){var clickEvent=_jquery.default.Event(_dropdown_events.default.click);this.getRoot().trigger(clickEvent,[element]),clickEvent.isDefaultPrevented()||e.preventDefault()}}.bind(this)),this.registerSearchListener()}registerSearchListener(){this.getDropdown().find(SELECTORS_SEARCH).on("input",function(e){let str=(0,_jquery.default)(e.target).val();var searchEvent=_jquery.default.Event(_dropdown_events.default.search,str);this.getRoot().trigger(searchEvent,[str]),searchEvent.isDefaultPrevented()||(e.preventDefault(),str.length>0?this.isSearching=!0:this.isSearching=!1,this.renderItems())}.bind(this))}getActiveItems(){return this.activeItems}setItemStatus(key){if(!(arguments.length>1&&void 0!==arguments[1])||arguments[1]){let item=this.getItems().get(key);this.activeItems.set(key,item)}else this.activeItems.delete(key)}reset(){this.isSearching=!1,this.getDropdown().find(SELECTORS_SEARCH).val(""),this.renderItems()}async render(){await _templates.default.render("local_qtracker/dropdown",{trigger:{key:"fa-times",title:"Close",alt:"Close pane",extraclasses:"",unmappedIcon:!1}}).then(((html,js)=>{_templates.default.replaceNodeContents(this.getDropdown(),html,js)}))}async generateItems(){let elements=[],items=this.isSearching?this.getItems():this.getActiveItems();if(0===items.size){let element=(0,_jquery.default)("<div></div>").addClass("dropdown-item disabled").attr("data-region","item").html(await(0,_str.get_string)("noitems","local_qtracker")).prop("outerHTML");elements.push(element)}else items.forEach(((html,key)=>{let element=(0,_jquery.default)("<div></div>").addClass("dropdown-item").addClass((()=>{if(this.isActiveItem(key))return"active"})).attr("data-value",key).attr("data-region","item").html(html).prop("outerHTML");elements.push(element)}));return elements}async renderItems(){this.empty();let elements=await this.generateItems();this.getDropdown().append(elements)}setItems(items){arguments.length>1&&void 0!==arguments[1]&&arguments[1]?(this.activeItems=new Map,items.forEach((item=>this.activeItems.set(item[0],item[1])))):(this.items=new Map,items.forEach((item=>this.items.set(item[0],item[1]))))}getItems(){return this.items}getAllItems(){return Array.prototype.concat(this.items,this.getActiveItems())}isActiveItem(key){return this.getActiveItems().has(key)}async search(str){str.length>0?this.isSearching=!0:this.isSearching=!1;let criteria=[];if(str.startsWith("#")){let id=parseInt(str.substr(1));criteria.push({key:"id",value:id})}else str.length>2&&(str+="%"),criteria.push({key:"title",value:str});let issues=(await(0,_api_helpers.loadIssuesData)(criteria)).issues;return this.setItems(issues),issues}setTitle(html){(0,_jquery.default)(".qtracker-sidebar-title").html(html)}setLoading(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0]?((0,_jquery.default)(".qtracker-sidebar-content .loading").addClass("show"),this.loading=!0):((0,_jquery.default)(".qtracker-sidebar-content .loading").removeClass("show"),this.loading=!1)}empty(){this.getDropdown().find(SELECTORS_ITEM).remove()}addTemplateItem(html,js){_templates.default.appendNodeContents(".qtracker-sidebar-content .qtracker-items",html,js)}getElements(){return(0,_jquery.default)(".qtracker-sidebar-content .qtracker-items").children()}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=dropdown.min.js.map