define("local_qtracker/question_issue_page",["exports","jquery","core/templates","core/ajax","core/url","core/str","local_qtracker/sidebar","local_qtracker/dropdown","local_qtracker/issue","core/modal_factory","core/modal_events","local_qtracker/dropdown_events","local_qtracker/api_helpers"],(function(_exports,_jquery,_templates,_ajax,_url,Str,_sidebar,_dropdown,_issue,_modal_factory,_modal_events,_dropdown_events,_api_helpers){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_templates=_interopRequireDefault(_templates),_ajax=_interopRequireDefault(_ajax),_url=_interopRequireDefault(_url),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_sidebar=_interopRequireDefault(_sidebar),_dropdown=_interopRequireDefault(_dropdown),_issue=_interopRequireDefault(_issue),_modal_factory=_interopRequireDefault(_modal_factory),_modal_events=_interopRequireDefault(_modal_events),_dropdown_events=_interopRequireDefault(_dropdown_events);var SELECTORS_TITLE_TEXT='[data-region="issuetitle-text"]',SELECTORS_TITLE_INPUT='[data-region="issuetitle-input"]';var _default=class{constructor(courseid,questionid,issueid){_defineProperty(this,"courseid",null),_defineProperty(this,"questionid",null),_defineProperty(this,"issueid",null),_defineProperty(this,"issue",null),_defineProperty(this,"parents",[]),_defineProperty(this,"filter",new Set(["Open","New"])),this.courseid=courseid,this.questionid=questionid,this.issueid=parseInt(issueid),this.issue=null,this.loadSettings(),this.editingTitle=!1,this.init()}async init(){this.checkForParents(),this.initSidebar(),this.initDropdowns(),this.registerEditTitleButtonListener()}async checkForParents(){let parentsData=await this.loadIssueParents(this.issueid);if(parentsData.parents.length>0){this.parents=parentsData.parents;let supersededids=this.parents.map((parent=>(0,_jquery.default)("<a></a>").attr("href",this._getIssueUrl(parent.id)).html("#"+parent.id).prop("outerHTML"))).join(", ");this.notify({message:await Str.get_string("issuesuperseded","local_qtracker",supersededids),announce:!1,type:"warning"},"#qtracker-superseded")}}loadSettings(){let filterData=JSON.parse(sessionStorage.getItem("local_qtracker_issue_page_filter"));null!==filterData&&filterData.forEach(this.filter.add,this.filter)}saveSettings(){let filterData=Array.from(this.filter);sessionStorage.setItem("local_qtracker_issue_page_filter",JSON.stringify(filterData))}async loadChildren(){return(await this.loadIssueChildren(this.issueid)).children.map((item=>[item.id,item.title]))}async getIssue(){return null===this.issue&&(this.issue=await _issue.default.load(this.issueid)),this.issue}registerEditTitleButtonListener(){(0,_jquery.default)(".edittitle").children("button").on("click",async function(e){let button=(0,_jquery.default)(e.target);if(this.editingTitle){let title=(0,_jquery.default)(SELECTORS_TITLE_INPUT).val(),issue=await this.getIssue();issue.setTitle(title),(await issue.save()).status&&(button.html(await Str.get_string("edit","core")),(0,_jquery.default)(SELECTORS_TITLE_INPUT).hide(),(0,_jquery.default)(SELECTORS_TITLE_TEXT).parent("div").show(),(0,_jquery.default)(SELECTORS_TITLE_TEXT).text(title),this.editingTitle=!1)}else button.html(await Str.get_string("save","core")),(0,_jquery.default)(SELECTORS_TITLE_INPUT).show(),(0,_jquery.default)(SELECTORS_TITLE_TEXT).parent("div").hide(),this.editingTitle=!0}.bind(this))}async initDropdowns(){let issuesDropdown=new _dropdown.default("#linkedissues-dropdown");issuesDropdown.setItems(await this.loadChildren(),!0),this.updateIssueAsideBlock(issuesDropdown.getActiveItems());let dropdown=issuesDropdown;dropdown.getRoot().on(_dropdown_events.default.search,async function(e,str){let criteria=[];if(str.startsWith("#")){let id=parseInt(str.substr(1));criteria.push({key:"id",value:id})}else str.length>2&&(str+="%"),criteria.push({key:"title",value:str});let items=(await(0,_api_helpers.loadIssuesData)(criteria)).issues.map((item=>{let html=item.title+' <span class="text-muted"> #'+item.id+"</span>";return[item.id,html]}));issuesDropdown.setItems(items),issuesDropdown.renderItems()}.bind(this)),dropdown.getRoot().on(_dropdown_events.default.click,async function(e,element){let parentid=parseInt(this.issueid),childid=parseInt(element.attr("data-value")),active=dropdown.isActiveItem(childid);if(active){(await this.deleteIssueRelation(parentid,childid)).status&&(this.renderSidebarContent(),issuesDropdown.setItemStatus(childid,!active),issuesDropdown.reset(),this.updateIssueAsideBlock(issuesDropdown.getActiveItems()))}else{let modal=await _modal_factory.default.create({title:await Str.get_string("subsumeissue","local_qtracker"),body:await Str.get_string("subsumeissueconfirm","local_qtracker",{child:childid,parent:parentid}),type:_modal_factory.default.types.SAVE_CANCEL,large:!1});modal.setSaveButtonText(await Str.get_string("confirm","core")),modal.getRoot().on(_modal_events.default.save,(async e=>{if(e.preventDefault(),(await this.setIssueRelation(parentid,childid)).status)this.renderSidebarContent(),issuesDropdown.setItemStatus(childid,!active),issuesDropdown.reset(),this.updateIssueAsideBlock(issuesDropdown.getActiveItems());else{let issueurl=(0,_jquery.default)("<a></a>").attr("href",this._getIssueUrl(childid)).html("#"+childid).prop("outerHTML");this.notify({message:await Str.get_string("errorsubsumingissue","local_qtracker",issueurl),announce:!0,closebutton:!0,type:"error"},"#qtracker-notifications")}modal.destroy()})),modal.getRoot().on(_modal_events.default.hidden,(()=>{modal.destroy()})),modal.show()}}.bind(this)),issuesDropdown.renderItems()}async updateIssueAsideBlock(items){let elements=[];if(0===items.size){let element=(0,_jquery.default)("<div></div>").addClass("dropdown-item disabled").html(await Str.get_string("noitems","local_qtracker")).prop("outerHTML");elements.push(element)}items.forEach(((html,key)=>{let element=(0,_jquery.default)("<a></a>").addClass("list-item border-0 p-1").attr("href",this._getIssueUrl(key)).html(html).prop("outerHTML");elements.push(element)})),(0,_jquery.default)(".linkedissues-list").html(elements)}_getIssueUrl(issueid){return _url.default.relativeUrl("/local/qtracker/issue.php",{courseid:this.courseid,issueid:issueid})}async renderSidebarContent(){this.sidebar.setLoading(!0),this.sidebar.empty();let issues=(await this.loadIssues(this.questionid,null)).issues,userids=[...new Set(issues.map((issue=>issue.userid)))],usersData=await this.loadUsersData(userids),promises=[];issues.forEach((async issueData=>{let userData=usersData.find((_ref=>{let{id:id}=_ref;return id===issueData.userid}));issueData.id!=this.issueid&&promises.push(this.addIssueItem(issueData,userData))})),self=this,_jquery.default.when.apply(_jquery.default,promises).done((function(){self.sidebar.setLoading(!1),_jquery.default.each(arguments,((index,argument)=>{self.sidebar.addTemplateItem(argument.html,argument.js)})),self.applyFilter()})).catch((e=>{console.error(e)}))}async initSidebar(){let sidebarOptions=[{name:"toggleclosed",text:"Show closed issues",value:0,checkbox:!0,active:this.filter.has("Closed")}];this.sidebar=new _sidebar.default("#question-issues-sidebar",!0,"left",!1,"30%","1.25rem",!1,sidebarOptions),await this.sidebar.render(),this.sidebar.empty(),this.sidebar.setLoading(!0);let question=(await this.loadQuestionData(this.questionid)).question,questionEditUrl=this.getQuestionEditUrl(this.courseid,this.questionid),link=(0,_jquery.default)("<a></a>").attr("href",questionEditUrl).html(question.name+" #"+question.id);this.sidebar.setTitle(link),this.sidebar.show(),await this.renderSidebarContent(),this.sidebar.getContainer().on("click",async function(e){let element=(0,_jquery.default)(e.target);if(element.hasClass("dropdown-item")){let dropdownItem=element.attr("data-name"),itemValue=parseInt(element.attr("data-value"));switch(dropdownItem){case"toggleclosed":element.is(":checked")?(this.filter.add("Closed"),element.prop("checked",!0)):(this.filter.delete("Closed"),element.prop("checked",!1)),this.applyFilter(),this.saveSettings();break;case"subsume":let parentid=this.issueid,childid=itemValue;(await this.setIssueRelation(parentid,childid)).status&&this.renderSidebarContent()}}}.bind(this)),window.closeIssuesPane=function(){this.sidebar.hide()}.bind(this),window.toggleIssuesPane=function(){this.sidebar.togglePane()}.bind(this)}applyFilter(){this.resetFilter();let self=this;this.sidebar.getItems().each((function(){self.filter.has((0,_jquery.default)(this).find(".badge").text())||(0,_jquery.default)(this).hide()}))}resetFilter(){this.sidebar.getItems().each((function(){(0,_jquery.default)(this).show()}))}async addIssueItem(issueData,userData){let extraClasses=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",issueurl=_url.default.relativeUrl("/local/qtracker/issue.php",{courseid:this.courseid,issueid:issueData.id}),userurl=_url.default.relativeUrl("/user/view.php",{course:this.courseid,id:userData.id}),paneContext=(issueData.id,{issueurl:issueurl,userurl:userurl,profileimageurl:userData.profileimageurlsmall,fullname:userData.fullname,timecreated:issueData.timecreated,id:issueData.id,title:issueData.title,description:issueData.description,extraclasses:extraClasses});return paneContext[issueData.state]=!0,_templates.default.render("local_qtracker/sidebar_item_issue",paneContext).then((function(html,js){return{html:html,js:js}}))}async loadIssues(id){let state=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,criteria=[{key:"questionid",value:id}];return state&&criteria.push({key:"state",value:state}),await _ajax.default.call([{methodname:"local_qtracker_get_issues",args:{criteria:criteria}}])[0]}async loadUsersData(ids){return await _ajax.default.call([{methodname:"core_user_get_users_by_field",args:{field:"id",values:ids}}])[0]}async setIssueRelation(parentid,childid){return await _ajax.default.call([{methodname:"local_qtracker_set_issue_relation",args:{parentid:parentid,childid:childid}}])[0]}async deleteIssueRelation(parentid,childid){return await _ajax.default.call([{methodname:"local_qtracker_delete_issue_relation",args:{parentid:parentid,childid:childid}}])[0]}getQuestionEditUrl(courseid,questionid){let returnurl=encodeURIComponent(location.pathname+location.search);return _url.default.relativeUrl("/question/bank/editquestion/question.php",{courseid:courseid,id:questionid,returnurl:returnurl})}decodeHTML(html){return(new DOMParser).parseFromString(html,"text/html").documentElement.textContent}async loadQuestionData(id){return await _ajax.default.call([{methodname:"local_qtracker_get_question",args:{id:id}}])[0]}async loadIssueParents(id){let userData;return userData=await _ajax.default.call([{methodname:"local_qtracker_get_issue_parents",args:{issueid:id}}])[0],userData}async loadIssueChildren(id){let userData;return userData=await _ajax.default.call([{methodname:"local_qtracker_get_issue_children",args:{issueid:id}}])[0],userData}notify(notification){let selector=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,template={success:"core/notification_success",info:"core/notification_info",warning:"core/notification_warning",error:"core/notification_error"}[(notification=_jquery.default.extend({closebutton:!1,announce:!1,type:"error",extraclasses:"show"},notification)).type];_templates.default.render(template,notification).then(((html,js)=>{null===selector?(0,_jquery.default)("#qtracker-notifications").append(html):(0,_jquery.default)(selector).append(html),_templates.default.runTemplateJS(js)})).catch((error=>{throw console.error(error),error}))}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=question_issue_page.min.js.map