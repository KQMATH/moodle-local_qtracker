function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("local_qtracker/question_issue_page",["exports","jquery","core/templates","core/ajax","core/url","core/str","local_qtracker/sidebar","local_qtracker/dropdown","local_qtracker/issue","core/modal_factory","core/modal_events","local_qtracker/dropdown_events","local_qtracker/api_helpers"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=p(b);c=p(c);d=p(d);e=p(e);f=o(f);g=p(g);h=p(h);i=p(i);j=p(j);k=p(k);l=p(l);function n(){if("function"!=typeof WeakMap)return null;var a=new WeakMap;n=function(){return a};return a}function o(a){if(a&&a.__esModule){return a}if(null===a||"object"!==_typeof(a)&&"function"!=typeof a){return{default:a}}var b=n();if(b&&b.has(a)){return b.get(a)}var c={},d=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var e in a){if(Object.prototype.hasOwnProperty.call(a,e)){var f=d?Object.getOwnPropertyDescriptor(a,e):null;if(f&&(f.get||f.set)){Object.defineProperty(c,e,f)}else{c[e]=a[e]}}}c.default=a;if(b){b.set(a,c)}return c}function p(a){return a&&a.__esModule?a:{default:a}}function q(a){return u(a)||t(a)||s(a)||r()}function r(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function s(a,b){if(!a)return;if("string"==typeof a)return v(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return v(a,b)}function t(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function u(a){if(Array.isArray(a))return v(a)}function v(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function w(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function x(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){w(h,d,e,f,g,"next",a)}function g(a){w(h,d,e,f,g,"throw",a)}f(void 0)})}}function y(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function z(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function A(a,b,c){if(b)z(a.prototype,b);if(c)z(a,c);return a}function B(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}var C={TITLE:"[data-region=\"issuetitle\"]",TITLE_TEXT:"[data-region=\"issuetitle-text\"]",TITLE_INPUT:"[data-region=\"issuetitle-input\"]"},D=function(){function a(b,c,d){y(this,a);B(this,"courseid",null);B(this,"questionid",null);B(this,"issueid",null);B(this,"issue",null);B(this,"parents",[]);B(this,"filter",new Set(["Open","New"]));this.courseid=b;this.questionid=c;this.issueid=parseInt(d);this.issue=null;this.loadSettings();this.editingTitle=!1;this.init()}A(a,[{key:"init",value:function(){var a=x(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:this.checkForParents();this.initSidebar();this.initDropdowns();this.registerEditTitleButtonListener();case 4:case"end":return a.stop();}}},a,this)}));return function init(){return a.apply(this,arguments)}}()},{key:"checkForParents",value:function(){var a=x(regeneratorRuntime.mark(function a(){var c=this,d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.loadIssueParents(this.issueid);case 2:d=a.sent;if(!(0<d.parents.length)){a.next=12;break}this.parents=d.parents;e=this.parents.map(function(a){return(0,b.default)("<a></a>").attr("href",c._getIssueUrl(a.id)).html("#"+a.id).prop("outerHTML")}).join(", ");a.t0=this;a.next=9;return f.get_string("issuesuperseded","local_qtracker",e);case 9:a.t1=a.sent;a.t2={message:a.t1,announce:!1,type:"warning"};a.t0.notify.call(a.t0,a.t2,"#qtracker-superseded");case 12:case"end":return a.stop();}}},a,this)}));return function checkForParents(){return a.apply(this,arguments)}}()},{key:"loadSettings",value:function loadSettings(){var a=JSON.parse(sessionStorage.getItem("local_qtracker_issue_page_filter"));if(null!==a){a.forEach(this.filter.add,this.filter)}}},{key:"saveSettings",value:function saveSettings(){var a=Array.from(this.filter);sessionStorage.setItem("local_qtracker_issue_page_filter",JSON.stringify(a))}},{key:"loadChildren",value:function(){var a=x(regeneratorRuntime.mark(function a(){var b,c,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.loadIssueChildren(this.issueid);case 2:b=a.sent;c=b.children;d=c.map(function(a){return[a.id,a.title]});return a.abrupt("return",d);case 6:case"end":return a.stop();}}},a,this)}));return function loadChildren(){return a.apply(this,arguments)}}()},{key:"getIssue",value:function(){var a=x(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:if(!(null===this.issue)){a.next=4;break}a.next=3;return i.default.load(this.issueid);case 3:this.issue=a.sent;case 4:return a.abrupt("return",this.issue);case 5:case"end":return a.stop();}}},a,this)}));return function getIssue(){return a.apply(this,arguments)}}()},{key:"registerEditTitleButtonListener",value:function registerEditTitleButtonListener(){(0,b.default)(".edittitle").children("button").on("click",function(){var a=x(regeneratorRuntime.mark(function a(c){var d,e,g,h;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=(0,b.default)(c.target);if(this.editingTitle){a.next=12;break}a.t0=d;a.next=5;return f.get_string("save","core");case 5:a.t1=a.sent;a.t0.html.call(a.t0,a.t1);(0,b.default)(C.TITLE_INPUT).show();(0,b.default)(C.TITLE_TEXT).parent("div").hide();this.editingTitle=!0;a.next=30;break;case 12:e=(0,b.default)(C.TITLE_INPUT).val();a.next=15;return this.getIssue();case 15:g=a.sent;g.setTitle(e);a.next=19;return g.save();case 19:h=a.sent;if(!h.status){a.next=30;break}a.t2=d;a.next=24;return f.get_string("edit","core");case 24:a.t3=a.sent;a.t2.html.call(a.t2,a.t3);(0,b.default)(C.TITLE_INPUT).hide();(0,b.default)(C.TITLE_TEXT).parent("div").show();(0,b.default)(C.TITLE_TEXT).text(e);this.editingTitle=!1;case 30:case"end":return a.stop();}}},a,this)}));return function(){return a.apply(this,arguments)}}().bind(this))}},{key:"initDropdowns",value:function(){var a=x(regeneratorRuntime.mark(function a(){var c,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=new h.default("#linkedissues-dropdown");a.t0=c;a.next=4;return this.loadChildren();case 4:a.t1=a.sent;a.t0.setItems.call(a.t0,a.t1,!0);this.updateIssueAsideBlock(c.getActiveItems());d=c;d.getRoot().on(l.default.search,function(){var a=x(regeneratorRuntime.mark(function a(b,d){var e,f,g,h,i;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:e=[];if(d.startsWith("#")){f=parseInt(d.substr(1));e.push({key:"id",value:f})}else{if(2<d.length)d+="%";e.push({key:"title",value:d})}a.next=4;return(0,m.loadIssuesData)(e);case 4:g=a.sent;h=g.issues;i=h.map(function(a){var b=a.title+" <span class=\"text-muted\"> #"+a.id+"</span>";return[a.id,b]});c.setItems(i);c.renderItems();case 9:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}().bind(this));d.getRoot().on(l.default.click,function(){var a=x(regeneratorRuntime.mark(function a(g,e){var h=this,i,l,m,n,o;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:i=parseInt(this.issueid);l=parseInt(e.attr("data-value"));m=d.isActiveItem(l);if(!m){a.next=10;break}a.next=6;return this.deleteIssueRelation(i,l);case 6:n=a.sent;if(n.status){this.renderSidebarContent();c.setItemStatus(l,!m);c.reset();this.updateIssueAsideBlock(c.getActiveItems())}a.next=30;break;case 10:a.t0=j.default;a.next=13;return f.get_string("subsumeissue","local_qtracker");case 13:a.t1=a.sent;a.next=16;return f.get_string("subsumeissueconfirm","local_qtracker",{child:l,parent:i});case 16:a.t2=a.sent;a.t3=j.default.types.SAVE_CANCEL;a.t4={title:a.t1,body:a.t2,type:a.t3,large:!1};a.next=21;return a.t0.create.call(a.t0,a.t4);case 21:o=a.sent;a.t5=o;a.next=25;return f.get_string("confirm","core");case 25:a.t6=a.sent;a.t5.setSaveButtonText.call(a.t5,a.t6);o.getRoot().on(k.default.save,function(){var a=x(regeneratorRuntime.mark(function a(d){var e,g;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d.preventDefault();a.next=3;return h.setIssueRelation(i,l);case 3:e=a.sent;if(!e.status){a.next=11;break}h.renderSidebarContent();c.setItemStatus(l,!m);c.reset();h.updateIssueAsideBlock(c.getActiveItems());a.next=18;break;case 11:g=(0,b.default)("<a></a>").attr("href",h._getIssueUrl(l)).html("#"+l).prop("outerHTML");a.t0=h;a.next=15;return f.get_string("errorsubsumingissue","local_qtracker",g);case 15:a.t1=a.sent;a.t2={message:a.t1,announce:!0,closebutton:!0,type:"error"};a.t0.notify.call(a.t0,a.t2,"#qtracker-notifications");case 18:o.destroy();case 19:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}());o.getRoot().on(k.default.hidden,function(){o.destroy()});o.show();case 30:case"end":return a.stop();}}},a,this)}));return function(){return a.apply(this,arguments)}}().bind(this));c.renderItems();case 11:case"end":return a.stop();}}},a,this)}));return function initDropdowns(){return a.apply(this,arguments)}}()},{key:"updateIssueAsideBlock",value:function(){var a=x(regeneratorRuntime.mark(function a(c){var d=this,e,g;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:e=[];if(!(0===c.size)){a.next=8;break}a.t0=(0,b.default)("<div></div>").addClass("dropdown-item disabled");a.next=5;return f.get_string("noitems","local_qtracker");case 5:a.t1=a.sent;g=a.t0.html.call(a.t0,a.t1).prop("outerHTML");e.push(g);case 8:c.forEach(function(a,c){var f=(0,b.default)("<a></a>").addClass("list-item border-0 p-1").attr("href",d._getIssueUrl(c)).html(a).prop("outerHTML");e.push(f)});(0,b.default)(".linkedissues-list").html(e);case 10:case"end":return a.stop();}}},a)}));return function updateIssueAsideBlock(){return a.apply(this,arguments)}}()},{key:"_getIssueUrl",value:function _getIssueUrl(a){var b=e.default.relativeUrl("/local/qtracker/issue.php",{courseid:this.courseid,issueid:a});return b}},{key:"renderSidebarContent",value:function(){var a=x(regeneratorRuntime.mark(function a(){var c=this,d,e,f,g,h,i;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=null;this.sidebar.setLoading(!0);this.sidebar.empty();a.next=5;return this.loadIssues(this.questionid,d);case 5:e=a.sent;f=e.issues;g=q(new Set(f.map(function(a){return a.userid})));a.next=10;return this.loadUsersData(g);case 10:h=a.sent;i=[];f.forEach(function(){var a=x(regeneratorRuntime.mark(function a(b){var d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=h.find(function(a){var c=a.id;return c===b.userid});if(!(b.id==c.issueid)){a.next=3;break}return a.abrupt("return");case 3:i.push(c.addIssueItem(b,d));case 4:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}());self=this;b.default.when.apply(b.default,i).done(function(){self.sidebar.setLoading(!1);b.default.each(arguments,function(a,b){self.sidebar.addTemplateItem(b.html,b.js)});self.applyFilter()}).catch(function(a){console.error(a)});case 15:case"end":return a.stop();}}},a,this)}));return function renderSidebarContent(){return a.apply(this,arguments)}}()},{key:"initSidebar",value:function(){var a=x(regeneratorRuntime.mark(function a(){var c,d,e,f,h,i;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=this.filter.has("Closed");d=[{name:"toggleclosed",text:"Show closed issues",value:0,checkbox:!0,active:c}];this.sidebar=new g.default("#question-issues-sidebar",!0,"left",!1,"30%","1.25rem",!1,d);a.next=5;return this.sidebar.render();case 5:this.sidebar.empty();this.sidebar.setLoading(!0);a.next=9;return this.loadQuestionData(this.questionid);case 9:e=a.sent;f=e.question;h=this.getQuestionEditUrl(this.courseid,this.questionid);i=(0,b.default)("<a></a>").attr("href",h).html(f.name+" #"+f.id);this.sidebar.setTitle(i);this.sidebar.show();a.next=17;return this.renderSidebarContent();case 17:this.sidebar.getContainer().on("click",function(){var a=x(regeneratorRuntime.mark(function a(c){var d,e,f,g,h,i;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=(0,b.default)(c.target);if(!d.hasClass("dropdown-item")){a.next=19;break}e=d.attr("data-name");f=parseInt(d.attr("data-value"));a.t0=e;a.next="toggleclosed"===a.t0?7:"subsume"===a.t0?11:18;break;case 7:if(d.is(":checked")){this.filter.add("Closed");d.prop("checked",!0)}else{this.filter.delete("Closed");d.prop("checked",!1)}this.applyFilter();this.saveSettings();return a.abrupt("break",19);case 11:g=this.issueid;h=f;a.next=15;return this.setIssueRelation(g,h);case 15:i=a.sent;if(i.status){this.renderSidebarContent()}return a.abrupt("break",19);case 18:return a.abrupt("break",19);case 19:case"end":return a.stop();}}},a,this)}));return function(){return a.apply(this,arguments)}}().bind(this));window.closeIssuesPane=function(){this.sidebar.hide()}.bind(this);window.toggleIssuesPane=function(){this.sidebar.togglePane()}.bind(this);case 20:case"end":return a.stop();}}},a,this)}));return function initSidebar(){return a.apply(this,arguments)}}()},{key:"applyFilter",value:function applyFilter(){this.resetFilter();var a=this;this.sidebar.getItems().each(function(){if(!a.filter.has((0,b.default)(this).find(".badge").text())){(0,b.default)(this).hide()}})}},{key:"resetFilter",value:function resetFilter(){this.sidebar.getItems().each(function(){(0,b.default)(this).show()})}},{key:"addIssueItem",value:function(){var a=x(regeneratorRuntime.mark(function a(b,d){var f,g,h,i,j,k=arguments;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:f=2<k.length&&k[2]!==void 0?k[2]:"";g=e.default.relativeUrl("/local/qtracker/issue.php",{courseid:this.courseid,issueid:b.id});h=e.default.relativeUrl("/user/view.php",{course:this.courseid,id:d.id});({trigger:{key:"fa-ellipsis-h",title:"Options",alt:"Show options",extraclasses:"",unmappedIcon:!1},header:!1,items:[{name:"subsume",text:"Subsume",value:b.id}]});i={issueurl:g,userurl:h,profileimageurl:d.profileimageurlsmall,fullname:d.fullname,timecreated:b.timecreated,id:b.id,title:b.title,description:b.description,extraclasses:f};j=b.state;i[j]=!0;return a.abrupt("return",c.default.render("local_qtracker/sidebar_item_issue",i).then(function(a,b){return{html:a,js:b}}));case 8:case"end":return a.stop();}}},a,this)}));return function addIssueItem(){return a.apply(this,arguments)}}()},{key:"loadIssues",value:function(){var a=x(regeneratorRuntime.mark(function a(b){var c,e,f,g=arguments;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=1<g.length&&g[1]!==void 0?g[1]:null;e=[{key:"questionid",value:b}];if(c){e.push({key:"state",value:c})}a.next=5;return d.default.call([{methodname:"local_qtracker_get_issues",args:{criteria:e}}])[0];case 5:f=a.sent;return a.abrupt("return",f);case 7:case"end":return a.stop();}}},a)}));return function loadIssues(){return a.apply(this,arguments)}}()},{key:"loadUsersData",value:function(){var a=x(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"core_user_get_users_by_field",args:{field:"id",values:b}}])[0];case 2:c=a.sent;return a.abrupt("return",c);case 4:case"end":return a.stop();}}},a)}));return function loadUsersData(){return a.apply(this,arguments)}}()},{key:"setIssueRelation",value:function(){var a=x(regeneratorRuntime.mark(function a(b,c){var e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"local_qtracker_set_issue_relation",args:{parentid:b,childid:c}}])[0];case 2:e=a.sent;return a.abrupt("return",e);case 4:case"end":return a.stop();}}},a)}));return function setIssueRelation(){return a.apply(this,arguments)}}()},{key:"deleteIssueRelation",value:function(){var a=x(regeneratorRuntime.mark(function a(b,c){var e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"local_qtracker_delete_issue_relation",args:{parentid:b,childid:c}}])[0];case 2:e=a.sent;return a.abrupt("return",e);case 4:case"end":return a.stop();}}},a)}));return function deleteIssueRelation(){return a.apply(this,arguments)}}()},{key:"getQuestionEditUrl",value:function getQuestionEditUrl(a,b){var c=encodeURIComponent(location.pathname+location.search),d=e.default.relativeUrl("/question/question.php",{courseid:a,id:b,returnurl:c});return d}},{key:"decodeHTML",value:function decodeHTML(a){var b=new DOMParser().parseFromString(a,"text/html");return b.documentElement.textContent}},{key:"loadQuestionData",value:function(){var a=x(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"local_qtracker_get_question",args:{id:b}}])[0];case 2:c=a.sent;return a.abrupt("return",c);case 4:case"end":return a.stop();}}},a)}));return function loadQuestionData(){return a.apply(this,arguments)}}()},{key:"loadIssueParents",value:function(){var a=x(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"local_qtracker_get_issue_parents",args:{issueid:b}}])[0];case 2:c=a.sent;return a.abrupt("return",c);case 4:case"end":return a.stop();}}},a)}));return function loadIssueParents(){return a.apply(this,arguments)}}()},{key:"loadIssueChildren",value:function(){var a=x(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return d.default.call([{methodname:"local_qtracker_get_issue_children",args:{issueid:b}}])[0];case 2:c=a.sent;return a.abrupt("return",c);case 4:case"end":return a.stop();}}},a)}));return function loadIssueChildren(){return a.apply(this,arguments)}}()},{key:"notify",value:function notify(a){var d=1<arguments.length&&arguments[1]!==void 0?arguments[1]:null;a=b.default.extend({closebutton:!1,announce:!1,type:"error",extraclasses:"show"},a);var e={success:"core/notification_success",info:"core/notification_info",warning:"core/notification_warning",error:"core/notification_error"}[a.type];c.default.render(e,a).then(function(a,e){if(null===d){(0,b.default)("#qtracker-notifications").append(a)}else{(0,b.default)(d).append(a)}c.default.runTemplateJS(e)}).catch(function(a){console.error(a);throw a})}}]);return a}();a.default=D;return a.default});
//# sourceMappingURL=question_issue_page.min.js.map
