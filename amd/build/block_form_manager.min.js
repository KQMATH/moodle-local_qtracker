define ("local_qtracker/block_form_manager",["jquery","core/str","core/templates","core/ajax","local_qtracker/issue","local_qtracker/issue_manager"],function(a,b,c,d,e,f){var g={SLOT:"[name=\"slot\"]",SLOT_SELECT_OPTION:"[name=\"slot\"] option",TITLE:"[name=\"issuetitle\"]",DESCRIPTION:"[name=\"issuedescription\"]",SUBMIT_BUTTON:"button[type=\"submit\"]",DELETE_BUTTON:"#qtracker-delete"},h=[g.TITLE,g.DESCRIPTION],i=null,j=function(b,c,d){this.contextid=d;this.form=a(b);this.form.closest(".card-text").prepend("<span class=\"notifications\" id=\"qtracker-notifications\"></span>");this.issueManager=new f;this.init(JSON.parse(c))};j.prototype.form=null;j.prototype.contextid=-1;j.prototype.issueid=null;j.prototype.issues=[];j.prototype.issueManager=null;j.prototype.init=function(){var b=this,c=0<arguments.length&&arguments[0]!==void 0?arguments[0]:[],d=a(g.SLOT_SELECT_OPTION);if(0==d.length)d=a(g.SLOT);d.map(function(a,c){var d=new e(null,parseInt(c.value),b.contextid);d.isSaved=!1;b.issueManager.addIssue(d)});this.issueManager.loadIssues(c).then(function(){var a=new FormData(b.form[0]);b.issueManager.setActiveIssue(parseInt(a.get("slot")));b.reflectFormState();var c=b.form.find(g.TITLE);c.change(function(a){b.issueManager.getActiveIssue().setTitle(a.target.value)});var d=b.form.find(g.DESCRIPTION);d.change(function(a){b.issueManager.getActiveIssue().setDescription(a.target.value)});var e=b.form.find(g.SLOT);e.change(b.handleSlotChange.bind(b));b.form.on("submit",b.submitFormAjax.bind(b))}).catch(function(a){console.error(a)})};j.prototype.handleSlotChange=function(a){this.issueManager.setActiveIssue(parseInt(a.target.value));this.reflectFormState();this.resetValidation()};j.prototype.reflectFormState=function(){var a=this.issueManager.getActiveIssue();if(!0===a.isSaved){this.toggleDeleteButton(!0);this.toggleUpdateButton(!0)}else if(!1===a.isSaved){this.clearForm()}this.restoreForm()};j.prototype.handleFormSubmissionResponse=function(a){console.log("jijjijij");Y.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()});this.issueManager.getActiveIssue().setId(a.issueid)};j.prototype.handleFormSubmissionFailure=function(a){console.error("An error occured");console.error(a)};j.prototype.clearForm=function(){this.form.find("#qtracker-delete").remove();this.resetValidation();b.get_string("submitnewissue","local_qtracker").then(function(a){this.form.find("button[type=\"submit\"]").html(a)}.bind(this))};j.prototype.restoreForm=function(){var a=this.issueManager.getActiveIssue();this.form.find("[name=\"issuetitle\"]").val(a.getTitle());this.form.find("[name=\"issuedescription\"]").val(a.getDescription())};j.prototype.editIssue=function(){var a=new FormData(this.form[0]);d.call([{methodname:"local_qtracker_edit_issue",args:{issueid:this.issueManager.getActiveIssue().getId(),issuetitle:a.get("issuetitle"),issuedescription:a.get("issuedescription")},done:function(a){b.get_string("issueupdated","local_qtracker").then(function(a){this.notify({message:a,announce:!0,type:"success"})}.bind(this));this.handleFormSubmissionResponse(a)}.bind(this),fail:this.handleFormSubmissionFailure.bind(this)}])};j.prototype.deleteIssue=function(){d.call([{methodname:"local_qtracker_delete_issue",args:{issueid:this.issueManager.getActiveIssue().getId()},done:function(){b.get_string("issuedeleted","local_qtracker").then(function(a){this.notify({message:a,announce:!0,type:"success"})}.bind(this));this.issueManager.getActiveIssue().isSaved=!1;this.clearForm()}.bind(this),fail:this.handleFormSubmissionFailure.bind(this)}])};j.prototype.createIssue=function(){var a=new FormData(this.form[0]);d.call([{methodname:"local_qtracker_new_issue",args:{qubaid:a.get("qubaid"),slot:a.get("slot"),contextid:this.contextid,issuetitle:a.get("issuetitle"),issuedescription:a.get("issuedescription")},done:function(a){b.get_string("issuecreated","local_qtracker").then(function(a){this.notify({message:a,announce:!0,type:"success"})}.bind(this));this.issueManager.getActiveIssue().isSaved=!0;this.toggleUpdateButton(!0);this.toggleDeleteButton(!0);this.handleFormSubmissionResponse(a)}.bind(this),fail:this.handleFormSubmissionFailure.bind(this)}])};j.prototype.cancelNotificationTimer=function(){if(i){clearTimeout(i)}i=null};j.prototype.notify=function(b){b=a.extend({closebutton:!0,announce:!0,type:"error",extraclasses:"show"},b);this.cancelNotificationTimer();var d={success:"core/notification_success",info:"core/notification_info",warning:"core/notification_warning",error:"core/notification_error"}[b.type];c.render(d,b).then(function(b,d){a("#qtracker-notifications").html(b);c.runTemplateJS(d);i=setTimeout(function(){a("#qtracker-notifications").find(".alert").alert("close")},7500)}).catch(function(a){console.error(a)})};j.prototype.toggleUpdateButton=function(a){if(a){b.get_string("update","core").then(function(a){this.form.find(g.SUBMIT_BUTTON).html(a)}.bind(this))}else{b.get_string("submitnewissue","local_qtracker").then(function(a){this.form.find(g.SUBMIT_BUTTON).html(a)}.bind(this))}};j.prototype.toggleDeleteButton=function(a){var b=this.form.find(g.DELETE_BUTTON);if(0==b.length&&a){c.render("local_qtracker/button",{type:"button",classes:"col-auto",label:"Delete",id:"qtracker-delete"}).then(function(a,b){var d=this.form.find("button").closest(".form-row");c.appendNodeContents(d,a,b);this.form.find("#qtracker-delete").on("click",function(){this.deleteIssue()}.bind(this))}.bind(this))}else{if(a){b.show()}else{b.hide()}}};j.prototype.setAction=function(a){this.form.data("action",a)};j.prototype.submitFormAjax=function(a){a.preventDefault();a.stopPropagation();if(!this.validateForm()){return}if(!0===this.issueManager.getActiveIssue().isSaved){this.editIssue()}else{this.createIssue()}};j.prototype.validateForm=function(){var a=this,b=!0;h.forEach(function(c){var d=a.form.find(c);if(""!=d.val()&&d.prop("validity").valid){d.removeClass("is-invalid").addClass("is-valid")}else{d.removeClass("is-valid").addClass("is-invalid");b=!1}});return b};j.prototype.resetValidation=function(){var a=this;h.forEach(function(b){var c=a.form.find(b);c.removeClass("is-invalid").removeClass("is-valid")})};j.prototype.submitForm=function(a){a.preventDefault();this.form.submit()};return{init:function init(a,b,c){return new j(a,b,c)}}});
//# sourceMappingURL=block_form_manager.min.js.map
